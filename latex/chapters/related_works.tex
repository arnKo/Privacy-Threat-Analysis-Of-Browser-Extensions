% !TeX spellcheck = en_US

\chapter{Related Works}
\label{chp:relatedWorks}

	In this chapter, we review related works that we discovered through our research and that left their mark on our design and concept. In the first section, we discuss the researches that directly affected the extension architecture that we analyze in this paper namely the work of Barth et al. which lay the foundation for the extension architecture and the work of Carlini et al. in which they evaluated the new architecture and conducted additional security features \cite{Barth10protectingbrowsers, Carlini:2012:EGC:2362793.2362800}. In the second section, we discuss the effort of others that already conducted a threat analysis of malicious browser extensions which we also contribute in our work. As third, we present efficient approaches to detect malicious extensions. Although we do not contribute in this section, the presented works provide a deeper understanding of possible malicious behavior.

\section{Extension Architecture}
\label{sec:relatedWorks:extensionArchitecture}

	The architecture of Firefox's Add-ons was the target of multiple scientific analysis which revealed several vulnerabilities such as an attacker being able to compromise the user's machine or to hide an installed, malicious extension completely from the user \cite{Bandhakavi:2011:VBE:1995376.1995398, TerLouw:2007:EWB:1420581.1420583}. The researchers proposed different approaches to improve the security for the user such as to find malicious code pattern \cite{Bandhakavi:2011:VBE:1995376.1995398}, monitor the extension at runtime and detect the theft of sensitive information \cite{Dhawan:2009:AIF:1723192.1723250, cs2015sentinel, TerLouw:2007:EWB:1420581.1420583}, or add an integrity check of an extension's code at runtime \cite{TerLouw:2007:EWB:1420581.1420583}. A very successful approach was proposed by Barth et al. who designed a new extension architecture that was later on adapted by multiple browsers \cite{Barth10protectingbrowsers}. 
	
	Barth et al. analyzed Firefox's Add-on model and found several vulnerabilities which may be used by an attacker to gain access to the user's computer. In their research, they focused on unintentional exploits in extensions which occur because extension developers are often hobby developers and not security experts. Firefox runs its extensions with the user's full privileges including to read and write local files and launch new processes. This gives an attacker who has compromised an extension the possibility to get control over the user's machine. 
	
	To decrease the attack surface in the case that an extension is compromised, Barth et al. proposed a new, more secured model for extensions. The new model consists of three main principles that should hamper an attacker who has successfully compromised an extension: 
	
	\begin{itemize}
		\item \textbf{Privilege Separation} Instead of running with the user's full privileges like Firefox Add-ons, the extension's content is divided into three components with different and unique privileges. Each \textit{content script} is executed in the scope of a single web page and has direct access to the web page's DOM. Therefore, it is exposed to potential attacks from malicious web pages and has no further privileges than to exchange messages with the extension's core. The \textit{core} contains the extension's main logic and for that purpose has access to the browser's provided API. It has neither direct access to web pages, nor to the user's machine. To get access to web content, the core can execute content scripts in the scope of a web page or execute XMLHttpRequests to communicate with a web server. To interact with the host machine, the core can send messages to optionally included \textit{native binaries} which are the only components of an extension that have access to the host machine with the user's full privileges. The researches state that these three layers which only communicate through a message channel, are more difficult for an attacker to break through because he has to find an exploit in each layer to finally get access to the user's system.
		
		\item \textbf{Least Privilege} The access to the browser's API is restricted. By default an extension has no access to any function provided by the browser. The developer has to explicit declare a set of functions to which his extension has access and the extension is not able to increase this set functions at runtime.
		
		\item \textbf{Strong Isolation} Each component of an extension runs in its own process on the operating system. This isolates them completely from each other because they do not share a common memory section and are therefore not able to invoke methods or access variable of each other. A second isolation mechanism called \textit{isolated world} separates content scripts and the underlying web page. Again, they run in their own, separated process on the operating system which effectively isolates them from each other, but the content script still has full access to the web page's DOM. To mitigate potential \textit{cross-origin JavaScript capability leaks} \cite{Barth:2009:CJC:1855768.1855780}, the content scripts and the web page host their own instance of the \texttt{document} object which mirrors the natively stored DOM of the web page. Any modification to the DOM is transmitted to all instances, but any other modification of the \texttt{document} object is not. 
	\end{itemize}
	
	\begin{figure}[h]
		\centering
		\def\svgscale{0.8}
		\input{./graphics/barth_overview.pdf_tex}
		\caption{Overview of the proposed extension architecture.}
		\label{fig:barthOverview}
	\end{figure}
	
	The extension architecture developed by Barth et al. was later on adapted by Google's developers for their Chrome browser. Carlini et al. evaluated Google's implementation and focused on the three security principles: \textit{isolated world}, \textit{privilege separation} and \textit{permissions} \cite{Carlini:2012:EGC:2362793.2362800}. For that purpose, they reviewed 100 extensions and found 40 containing vulnerabilities of which 31 could have been avoided if the developer would have followed simple security best practices such as using HTTPS instead of HTTP and the DOM property \texttt{innerText} that does not allow inline scripts to execute instead of \texttt{innerHtml}. 
	
	\begin{itemize}
		\item Evaluating the isolated world mechanism, they found only three extensions with vulnerabilities in content scripts; two due to the use of eval. Hence, they stated that isolated world effectively shields content scripts from malicious web pages, if the developer does not implement explicit cross site scripting attack vectors.
		
		\item Privilege separation should protect the extension's background from compromised content scripts. But Carlini et al. discovered that it is rarely needed because content scripts are already effectively protected by the isolated world mechanism. They discovered that network attacks are a bigger threat to the extension's background than attacks from a web page. An attacker can compromise an extension by modifying a remote loaded script that was fetched over a HTTP request. 
		
		\item The permission system acts as security mechanism in the case that the extension's background is compromised. Their review showed that developers of vulnerable extensions still used permissions in a way that reduced the scope of their vulnerability. 
	\end{itemize} 

	To increase the security of Chrome extensions, Carlini et al. proposed to ban the loading of remote scripts over HTTP and inline scripts inside the extension's background. They did not propose to ban the use of eval in light of the facts that eval itself was mostly not the reason for a vulnerability and banning it would break several extensions. Google's developers were responsive to the exposed vulnerabilities and added a default Content Security Policy to the extension's background \cite{chromiumBlogCSP}. Furthermore, they disabled the fetching of remote scripts with HTTP using script elements inside the extension's background script. 
 
 	In our work, we contribute an analysis of the extension architecture with the focus on intentionally implemented attacks to harm the extension's current user and his privacy. Our research shows that although the extension architecture holds many security features, it does not shield the user from intentionally implemented malicious behavior.
 
 \section{Threat Analysis of Malicious Extensions}
 \label{sec:relatedWorks:threatAnalysis}
 
	Other researchers have already investigated the threats that arise from a malicious extension. For that purpose, they followed a workflow that we also use in our research. They examined the extension's architecture, pointed explicit threats, and implemented an extension that uses found threats as a proof-of-concept.
 
	Liu et al. evaluated the security of Chrome's extension architecture against intentional malicious extensions \cite{Liu12chromeextensions:}. Their implementation of a malicious extension is able to execute password sniffing, email spamming, DDoS, and phishing attacks. The extension needs minimal permissions to execute the attacks such as access to the tab system and access to all web pages with the \texttt{http://*/*} and \texttt{https://*/*} permissions. To demonstrate that those permissions are used in real world extensions, they analyzed popular extensions and revealed that 19 out of 30 evaluated extensions did indeed use the \texttt{http://*/*} and \texttt{https://*/*} permissions. Furthermore, they analyzed threat models which exists due to default permissions such as full access to the DOM and the possibility to unrestrictedly communicate with the origin of the associated web page. These capabilities allow malicious extension to execute cross-site request forgery attacks and to transfer unwanted information to any host. To increase the privacy of a user, Liu et al. proposed a more fine grained permission architecture. They included the access to DOM elements in the permission system in combination with a rating system to determine elements which probably contain sensitive information such as password fields or can be used to execute web requests such as iframes or images. 
	 	
	A further research about malicious Chrome extensions demonstrates a large list of possible attacks to harm the user's privacy \cite{extensions:cns14}. Bauer et al. implemented several attacks such as stealing sensitive information, executing forged web request, and tracking the user. All their implemented attacks work with minimal permissions and often use the \texttt{http://*/*} and \texttt{https://*/*} permissions. They also exposed that an extension may hide it's malicious intend by not requiring suspicious permissions. To still execute attacks, the extension may communicate with another extension which has needed permissions.
	 
	Ter Louw et al. evaluated Firefox's Add-on model with the main goal to ensure the integrity of an extension's code \cite{TerLouw:2007:EWB:1420581.1420583}. They implemented an extension to show that it is possible to manipulate the browser beyond the features that Firefox provides to its extensions. They used the found exploits to hide their extension completely by removing it from the list of installed extensions and injecting it into an presumably benign extension. Furthermore, their extension collects any user input and data and sends it to an remote server. The integrity of an extension's code can be harmed because Firefox signs the integrity on the extension's installation but does not validate it when loading the extension. Therefore, an malicious extension can undetected integrate code into an installed extension. To remove this vulnerability Ter Louw et al. proposed user signed extensions. On installation the user has to explicit allow the extension which is then signed with a hash certificate. The extension's integrity will be tested against the certificate when it is loaded. 

	By contrast with presented researches, we do not limit our self to the extension architecture of a single browser but instead focus on a cross-browser architecture. For that purpose, we ensured that our proof-of-concept implementations work as expected in all applicable browsers. Furthermore, our extension analysis shows that even complex attack scenarios can be executed with existing extensions.
	
\section{Detection Of Malicious Extensions}
\label{sec:relatedWorks:detectionOfMaliciousExtensions} 
	
	\textit{Hulk} is an dynamic analysis and classification tool for chrome extensions \cite{184485}. It categorizes analyzed extensions based on discoveries of actions that may or do harm the user. An extension is labeled \textit{malicious} if behavior was found that is harmful to the user. If potential risks are present or the user is exposed to new risks, but there is no certainty that these represent malicious actions, the extension is labeled as \textit{suspicious}. This occurs for example if the extension loads remote scripts where the content can change without any relevant changes in the extension. The script needs to be analyzed every time it is loaded to verify that it is not malicious. The developers stated that his task can not be accomplished by their analysis tool. Lastly an extension without any trace of suspicious behavior is labeled as \textit{benign}.  Kapravelos et al. used Hulk in their research to analyze a total of 48,322 extensions where they labeled 130 (0.2\%) as malicious and 4,712 (9.7\%) as suspicious. \\
	Before the actual analysis, Hulk performs static preparations such as to collect URLs that may trigger the extension's behavior. The extension's source code and especially the manifest file with its host permissions and URL pattern for content scripts serve as sources. Additionally, the developer fed Hulk with popular websites such as Facebook, Amazon, or Twitter. This task has its limitation. Hulk has no account creation on the fly and can therefore not access account restricted web pages. \\
	The actual, dynamic analysis consists of the monitoring and evaluating of API calls, in- and outgoing web requests, and injected content scripts. Some calls to Chrome's extension API are considered malicious such as uninstalling other extensions or preventing the user to uninstall the extension itself. This is often accomplished by closing Chrome's extension page as soon as the user opens it and therefore denying the user access. Web requests are analyzed for modifications such as removing security relevant headers or changing the target server. To analyze the interaction with or manipulation of a web page Hulk uses so called \textit{honey pages}. These consist of overridden DOM query functions that create elements on the fly. If a script queries for a DOM element the honey page creates it and monitors any interaction. 
	
	\textit{WebEval} is an analysis tool to identify malicious Chrome extensions \cite{190984}. Its main goal is to reduce the amount of human resources needed to verify that an extension is indeed malicious. Therefore, it relies on an automatic analysis process whose results are valuated by a machine learning algorithm. Ideally the system would run without human interaction. The research of Jagpal et al. shows that the false positive and false negative rates of their system decreases over time but new threats result in a sharp increase. They arrived at the conclusion that human experts must always be a part of their system. In three years of usage WebEval analyzed 99,818 extensions in total and identified 9,523 (9.4\%) malicious extensions. Automatic detection identified 93.3\% of malicious extensions which were already known and 73,7\% of extensions flagged as malicious were confirmed by human experts. \\
	In addition to their analysis pipeline they stored every revision of an extension that was distributed to the Google Chrome web store in the time of their research. A weakly rescan targets extensions that fetch remote resources that may become malicious. New extensions are compared to stored extensions to identifying near duplicated extensions and known malicious code pattern. WebEval also targets the identification of developer who distribute malicious extensions and fake accounts inside the Google Chrome web store. Therefore reputation scans of the developer, the account's email address and login position are included in the analysis process.  \\
	The extension's behavior is dynamically analyzed with generic and manual created behavioral suits. Behavioral suits replay recorded interactions with a web page to trigger the extension's logic. Generic behavioral suits include techniques developed by Kapravelos	et al. for Hulk \cite{184485} such as \textit{honeypages}. Manual behavioral suits test an extension's logic explicit against known threats such as to uninstall another extension or modify CSP headers. In addition, they rely on anti virus software to detect malicious code and domain black lists to identify the fetching of possible harmful resources. If new threats surface WebEval can be expanded to quickly respond. New behavioral suits and detection rules for the self learning algorithm can target explicit threats. 
	
	\textit{VEX} is a static analysis tool for Firefox Add-ons \cite{Bandhakavi:2011:VBE:1995376.1995398}. Bandhakavi et al. analyzed the work flow of Mozilla's developers who manually analyze new Firefox Add-ons by searching for possible harmful code pattern. They implemented VEX to extend and automatize the developer's search and minimize the amount of false-positive results. VEX statically analyses the flow of information in the source code and creates a graph system that represents all possible information flows. They created pattern for the graph system that detect possible cross-site scripting attacks with \textit{eval} or the DOM function \textit{innerHtml} and Firefox specific attacks that exploit the improper use of \textit{evalInSandbox} or wrapped JavaScript objects. More vulnerabilities can be covered by VEX by adding new flow pattern. VEX targets buggy Add-ons without harmful intent or code obfuscation. 
	