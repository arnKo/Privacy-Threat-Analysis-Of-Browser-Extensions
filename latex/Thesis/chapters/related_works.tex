% !TeX spellcheck = en_US

\chapter{Related Works}
\label{chp:relatedWorks}

	In this chapter, we review related works that we discovered during our research and that left their mark on our design and concept. In the first section, we discuss the research that directly affected the extension architecture that we analyze in this paper namely the work of Barth et al. which lays the foundation for the extension architecture, and the work of Carlini et al., in which they evaluated the new architecture and conducted additional security features \cite{Barth10protectingbrowsers, Carlini:2012:EGC:2362793.2362800}. In the second section, we present existing works on extension threat analysis. Thirdly, we present existing approaches to detect malicious extensions.

\section{Extension Architecture}
\label{sec:relatedWorks:extensionArchitecture}

	Firefox's initial extension architecture called \textit{Add-ons} was the subject of multiple scientific analyses which revealed several vulnerabilities such as an attacker being able to compromise the user's machine or to hide an installed, malicious extension completely from the user \cite{Bandhakavi:2011:VBE:1995376.1995398, TerLouw:2007:EWB:1420581.1420583}. The researchers proposed different approaches to improve the security for the user such as to find malicious code pattern \cite{Bandhakavi:2011:VBE:1995376.1995398}, monitor the extension at runtime and detect the theft of sensitive information \cite{Dhawan:2009:AIF:1723192.1723250, cs2015sentinel, TerLouw:2007:EWB:1420581.1420583}, or add an integrity check of an extension's code at runtime \cite{TerLouw:2007:EWB:1420581.1420583}. A very successful approach was proposed by Barth et al. who designed a new extension architecture that was later on adapted by multiple browsers \cite{Barth10protectingbrowsers}. 
	
	Barth et al. analyzed Firefox's Add-on model and found several vulnerabilities which may be used by an attacker to gain access to the user's computer. In their research they focused on unintentional security vulnerabilities in extensions which occur because extension developers are often not security experts. Firefox runs its extensions with the user's full privileges including to read and write local files and launch new processes. This gives an attacker, who has compromised an extension, the possibility to get control over the user's machine. 
	
	Barth et al. proposed a new, more secured model for extensions. In the case that an extension is compromised, the attacker's operating range is minimized. The proposed architecture was adapted by Google's developers for their Chrome browser in 2010. Carlini et al. evaluated the security mechanisms of Google's implementation and reviewed 100 extensions \cite{Carlini:2012:EGC:2362793.2362800}. They discovered 40 containing vulnerabilities of which 31 could have been avoided if the developer would have followed simple security best practices such as using HTTPS instead of HTTP and the DOM property \texttt{innerText} that does not execute inline scripts instead of \texttt{innerHtml}. They stated, that the architecture's security mechanisms effectively protect the user from an attacker who uses a malicious web page. However, they discovered that network attacks are a bigger threat to the extension than attacks from a web page. An attacker can compromise an extension by modifying a remotely loaded script that was fetched over a HTTP request. 
	
	In order to increase the security of Chrome extensions, Carlini et al. proposed to ban the loading of remote scripts over HTTP and inline scripts inside the extension's core scripts. They did not propose to ban the use of eval in light of the facts that eval itself was mostly not the reason for a vulnerability and banning it would break several extensions. Google's developers were responsive to the exposed vulnerabilities and added a default Content Security Policy to web pages inside the extension \cite{chromiumBlogCSP}. Furthermore, they disabled the fetching of remote scripts with HTTP using script elements inside the extension's web pages.
 
 	In our work, we conduct a privacy threat analysis of browser extensions focusing on intentionally implemented attacks targeting the current user. Our research shows that although the extension architecture provides many security features, it does not protect the user from intentionally implemented malicious behavior.
 
 \section{Threat Analysis of Malicious Extensions}
 \label{sec:relatedWorks:threatAnalysis}
 
	Other researchers have already investigated the threats that arise from a malicious extension. For that purpose, they followed a workflow that we also use in our research. They examined the extension's architecture, pointed explicit threats, and implemented a proof-of-concept that uses discovered threats.
 
	Liu et al. conducted a threat analysis of Chrome extensions and discovered that the extension's unrestricted access to the web page and the possibility to execute unrestricted web requests pose harm to the user's privacy \cite{Liu12chromeextensions:}. These capabilities enables a malicious extension to extract and transfer sensitive user information from any web page that the user visits. The researcher's analysis revealed that the extension's components share the same set of privileges which leads to some components having privileges they do not need. This violates the principle of least-privileges which was intended by the designers and therefore facilitates the integration of malicious behavior. 
	If the extension requests the privileges to access a specific origin, the extension is allowed to access matching web pages and to programmatically execute web requests to the server. Liu et al. proposed separated privileges for each component and to split them based on particular operations such as to inject a script or execute a web request. However, the scripts that can access the web page's DOM are still able to execute unrestricted web requests by adding an element to the DOM that fetches a resource from a remote origin. To mitigate this threat, the researchers proposed to restrict the extension and allows that only content from listed origins can be added to the DOM. \\
	Furthermore, an extension has unrestricted access to the web page and its content. This allows a malicious extension to extract sensitive information. Liu et al. proposed a categorization of DOM elements to identify container of sensitive information and restricted access to these elements by default. \textit{High level} elements such as input elements of type password or hidden contain inherently sensitive information. To identify \textit{medium level} elements that may contain sensitive information, the researchers proposed a catalog with regular expressions that match code words such as \textit{username}. Finally, every element else is categorized as \textit{low level}. By default, an extension should have only access to low level elements and the extension may request access to the other levels by a proper permission. \\
 	
	In another research, Liu et al. demonstrated the possibility to user extensions in a botnet \cite{liu2011botnet}. As a proof-of-concept, they developed an extension for Chrome and another for Internet explorer that act as bots. The extensions are able to execute DDoS attacks, email spamming, and steal the user's credentials. To send an email, the extension uses the user's email account. If the user logs into his account, the extension executes a web request to send an email with the spamming content. The email server will actually execute the request because the user is currently authenticated. \\
 	A botnet needs a communication channel that allows the attacker to control the bots. For their extensions, the researchers use the automatic update and modify the content of a configuration file. The extension reads the file and acts accordingly. After the attacker publishes a new update, which will start a new attack, the update will be installed as soon as the browser is active. 
 	
	Another research about malicious Chrome extensions demonstrates a large list of possible attacks against the user's privacy \cite{extensions:cns14}. Bauer et al. implemented several attacks such as stealing sensitive information, executing CSRF attacks, and tracking the user. 
	 
	Ter Louw et al. evaluated Firefox's Add-on model with the main goal to ensure the integrity of an extension's code \cite{TerLouw:2007:EWB:1420581.1420583}. They implemented an extension to show that it is possible to manipulate the browser beyond the features that Firefox provides to its extensions. They used the found exploits to hide their extension completely by removing it from the list of installed extensions and injecting it into an presumably benign extension. Furthermore, their extension collects any user input and data and sends it to an remote server. Firefox can not ensure the integrity of an extension's code because it does not validate it when loading the extension. Therefore, a malicious extension can silently integrate code into another installed extension. In order to remove this vulnerability, Ter Louw et al. proposed so-called user-signed extensions. The user has to explicitly allow the installation of an extension which is then signed with a user's certificate. The extension's integrity will be tested against the certificate when it is loaded. 

	In our work, we do not limit ourselves to the extensions of a specific browser, but instead focus on a cross-browser architecture. For that purpose, we ensured that our proof-of-concept implementations work as expected in all applicable browsers. Furthermore, our extension analysis shows that even complex attack scenarios can be executed with existing extensions.
	
\section{Detection Of Malicious Extensions}
\label{sec:relatedWorks:detectionOfMaliciousExtensions} 
	
	There are several works on automatic detection of malicious extensions. We present two works that focus on Chrome extensions and one that focuses on Firefox Add-ons.
	
	\textit{Hulk} is an dynamic analysis and classification tool for chrome extensions \cite{184485}. It categorizes analyzed extensions based on discoveries of actions that may or do harm the user. An extension is labeled \textit{malicious} if behavior was found that is harmful to the user. If potential risks are present or the user is exposed to new risks, but there is no certainty that these represent malicious actions, the extension is labeled as \textit{suspicious}. This occurs, for example, if the extension remotely loads scripts whose content can change without any relevant changes in the extension. The script needs to be analyzed every time it is loaded to verify that it is not malicious. The developers stated that this task can not be accomplished by their analysis tool. Lastly, an extension without any trace of suspicious behavior is labeled as \textit{benign}.  Kapravelos et al. used Hulk in their research to analyze a total of 48,322 extensions, where they labeled 130 (0.2\%) as malicious and 4,712 (9.7\%) as suspicious. \\
	Before the actual analysis, Hulk performs static preparations such as to collect URLs from the extension's source code that may trigger its behavior. Additionally, the developer fed Hulk with popular websites such as Facebook, Amazon, or Twitter. This task has its limitations. The presented solution is not able to create accounts and therefore cannot access web pages specific to a concrete account. \\
	The actual, dynamic analysis consists of the monitoring and evaluating of API calls, in- and outgoing web requests, and injected content scripts. Some calls to Chrome's extension API are considered malicious, such as uninstalling other extensions or preventing the user to uninstall the extension itself. This is often accomplished by closing Chrome's extension page as soon as the user opens it and therefore denying the user access. Web requests are analyzed for modifications such as removing security relevant headers or changing the target server. Hulk uses so called \textit{honey pages} to analyze the interaction with a web page or its manipulation by an extension. These consist of overridden DOM query functions that create elements on the fly. If a script queries for a DOM element, the honey page creates it and monitors any interaction. 
	
	\textit{WebEval} is an analysis tool to identify malicious Chrome extensions \cite{190984}. Its main goal is to reduce the amount of human resources needed to verify that an extension is indeed malicious. Therefore, it relies on an automatic analysis process whose results are valuated by a machine learning algorithm. Ideally, the system runs without human interaction. The research of Jagpal et al. shows that the false positive and false negative rates of their system decreases over time but new threats result in a sharp increase. They concluded that human experts must always be a part of their system. In three years of usage, WebEval analyzed 99,818 extensions in total and identified 9,523 (9.4\%) malicious extensions. Automatic detection identified 93.3\% of malicious extensions which were already known and 73,7\% of extensions flagged as malicious were confirmed by human experts. \\
	In addition to their analysis pipeline they stored every revision of an extension that was distributed to the Google Chrome web store in the time of their research. A weakly rescan targets extensions that fetch remote resources that may become malicious. New extensions are compared to stored extensions to identify almost duplicated extensions and known malicious code pattern. WebEval also targets the identification of the developer who distributes malicious extensions and fake accounts inside the Google Chrome web store. Therefore reputation scans of the developer, the account's email address and login position are included in the analysis process.  \\
	The extension's behavior is dynamically analyzed with generic and manual created behavioral suits. Behavioral suits replay recorded interactions with a web page to trigger the extension's logic. Generic behavioral suits include techniques developed by Kapravelos	et al. for Hulk \cite{184485} such as \textit{honeypages}. Manual behavioral suits test an extension's logic explicit against known threats such as to uninstall another extension or modify CSP headers. In addition, they rely on anti-virus software to detect malicious code and domain black lists to identify the fetching of possible harmful resources. If new threats surface WebEval can be expanded to quickly respond. New behavioral suits and detection rules for the self learning algorithm can target explicit threats. 
	
	\textit{VEX} is a static analysis tool for Firefox Add-ons \cite{Bandhakavi:2011:VBE:1995376.1995398}. Bandhakavi et al. analyzed the work flow of Mozilla's developers who manually analyze new Firefox Add-ons by searching for possible harmful code pattern. They implemented VEX to extend and automatize the developer's search and minimize the amount of false-positive results. VEX statically analyses the flow of information in the source code and creates a graph system that represents all possible information flows. They created a pattern for the graph system that detects possible cross-site scripting attacks with \textit{eval} or the DOM function \textit{innerHtml} and Firefox specific attacks that exploit the improper use of \textit{evalInSandbox} or wrapped JavaScript objects. More vulnerabilities can be covered by VEX by adding new flow pattern. VEX targets buggy Add-ons without harmful intent or code obfuscation. 
	